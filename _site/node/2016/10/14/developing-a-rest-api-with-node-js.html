<p>This article will cover the directory structure, through the small design decisions made during development, and finally to the code itself.</p>

<p>This article will display the entire source code for the example API shown in the article <a href="'http://develdoe.com/2016/planning-a-rest-api/'">Planning a REST API</a>.</p>

<p>We’ll go over the relevant parts. Sadly, some bits and pieces are just plain boring (like the JSON Schema definitions and the simpler models), so I’ll skip it. These things should be pretty self-explanatory to developers anyway, no matter the level of expertise. I’ll cover the development stage as follows:</p>

<ul>
  <li>Minor simplifications/design decisions made during development.</li>
  <li>Folder structure, it’s important to understand where everything is and why.</li>
  <li>The code itself, file by file, including explanation when needed.</li>
</ul>

<h2 id="minor-changes">Minor Changes</h2>

<p>We spent two whole articles going over different modules and planning the entire process to develop the API, and yet the plan changes.</p>

<p>There is no escape from minor changes at this stage, unless you spend a lot more time in your design phase.</p>

<p>We’ll just keep the employees’ records unaware of their assigned store, simplifying the store employee relationship and We’ll work under the premise that we’re not really making a public API.</p>

<p>That means that we will not require every client to request an access token. Instead, we share a secret passphrase; so clients will always send the MAC code encrypted using this passphrase, and the API will rehash each request to make sure both results match. This way we’re still validating the requests and we remain true to REST.</p>

<p>We’ll Add Swagger UI to test our API. You need <a href="https://github.com/swagger-api/swagger-ui">download</a> it from and add it into your project. Because the Swagger UI has no de facto support for our authentication scheme. We can send a fixed api_key parameter, but we would have to change the code of the client to get it to use the same algorithm we’re using. This is why we’ve added a small backdoor in our code to let the Swagger UI go by without needing to authenticate each request.</p>

<p>The hack is very simple. Since the UI can send a fixed api_key, we’ll let all requests that have an api_key equal to 777 pass, automatically trusting them. This backdoor will need to be removed when going into production.</p>

<p>We’ll use the MVC pattern, this means we’ll be having the following elements in out project:</p>

<ul>
  <li><strong>Controllers</strong>: Handles requests and calls upon the models for further action.</li>
  <li><strong>Models</strong>: Holds the main logic of the API. Since in our simple case that logic is basically querying the database, these will be the models used by Mongoose. This will simplify our architecture. Also, Mongoose provides different mechanisms to add extra behaviors to our models (things like setting instance methods or post-action hooks).</li>
  <li><strong>View</strong>: The view will be embedded inside the model’s code in the form of a method that translates the specifics of one model into a HAL + JSON that can be returned back to the client.</li>
</ul>

<h2 id="folder-structure">Folder Structure</h2>

<p><img src="img/posts/folder_Struct.png" alt="folder_Struct.png" /></p>

<ul>
  <li><strong>controllers</strong>: This folder contains the code for our controllers. It also has an index.js file to handle exporting the contents of the rest of them. There is also a base controller here, which contains all the generic methods that all controllers should have; so every new controller can extend this and inherit said methods.</li>
  <li><strong>lib</strong>: This folder contains the miscellaneous code not big enough to have its own folder, but required across several different places in our project; for instance, database access, helper functions, the config files, and so forth.</li>
  <li><strong>models</strong>: Inside this folder are the model files. Normally when working with Mongoose, a model’s file has the schema definition, and you return the instantiation of that schema as your model. In our case, the actual definition is somewhere else, so this code handles loading that external definition, adding the extra behavior specific to each model, and then returning it.</li>
  <li><strong>request_schemas</strong>: Inside this folder are the JSON Schemas used to validate the different requests.</li>
  <li><strong>schemas</strong>: These are the JSON Schemas of the models, used for the Swagger module to define the UI for testing and for the Mongoose model’s definition. We will have to add some code to translate from the first one to the latter, since they don’t use the same format.</li>
  <li><strong>swagger-ui</strong>: This folder contains the contents of the Swagger UI project. We’ll need to do some minor adjustments to the index.html file to make it work as we expect it.</li>
</ul>

<h2 id="source-code">Source Code</h2>

<p>Here I’ll list the entire code for the project, including some basic description of the code if required. I’ll go folder by folder.</p>

<h3 id="controllers">controllers</h3>

<p><em>/controllers/index.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
           <span class="na">BookSales</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./booksales"</span><span class="p">),</span>
           <span class="na">Stores</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./stores"</span><span class="p">),</span>
           <span class="na">Employees</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./employees"</span><span class="p">),</span>
           <span class="na">ClientReviews</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./clientreviews"</span><span class="p">),</span>
           <span class="na">Clients</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./clients"</span><span class="p">),</span>
           <span class="na">Books</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./books"</span><span class="p">),</span>
           <span class="na">Authors</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./authors"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This file is used to export each controller. Using this technique lets us import the entire folder as a module: <code class="highlighter-rouge">var controllers = require("/controllers")</code></p>

<p><em>/controllers/basecontroller.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span>
    <span class="nx">_</span> <span class="o">=</span>         <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">),</span>
    <span class="nx">restify</span> <span class="o">=</span>   <span class="nx">require</span><span class="p">(</span><span class="s2">"restify"</span><span class="p">),</span>
    <span class="nx">colors</span> <span class="o">=</span>    <span class="nx">require</span><span class="p">(</span><span class="s2">"colors"</span><span class="p">),</span>
    <span class="nx">halson</span> <span class="o">=</span>    <span class="nx">require</span><span class="p">(</span><span class="s2">"halson"</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">BaseController</span><span class="p">(){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">actions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">server</span> <span class="o">=</span> <span class="kc">null</span>
<span class="p">}</span>

<span class="nx">BaseController</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">setUpActions</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">app</span><span class="p">,</span><span class="nx">sw</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">server</span> <span class="o">=</span> <span class="nx">app</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">act</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">method</span> <span class="o">=</span> <span class="nx">act</span><span class="p">[</span><span class="s1">'spec'</span><span class="p">][</span><span class="s1">'method'</span><span class="p">]</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"setting up auto-doc for ("</span><span class="p">,</span> <span class="nx">method</span><span class="p">,</span> <span class="s2">") - "</span><span class="p">,</span> <span class="nx">act</span><span class="p">[</span><span class="s1">'spec'</span><span class="p">][</span><span class="s1">'nickname'</span><span class="p">])</span>
        <span class="nx">sw</span><span class="p">[</span><span class="s1">'add'</span> <span class="o">+</span> <span class="nx">method</span><span class="p">](</span><span class="nx">act</span><span class="p">)</span>
        <span class="nx">app</span><span class="p">[</span><span class="nx">method</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()](</span><span class="nx">act</span><span class="p">[</span><span class="s1">'spec'</span><span class="p">][</span><span class="s1">'path'</span><span class="p">],</span> <span class="nx">act</span><span class="p">[</span><span class="s1">'action'</span><span class="p">])</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="nx">BaseController</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">addAction</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">spec</span><span class="p">,</span> <span class="nx">fn</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">newAct</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">'spec'</span><span class="p">:</span> <span class="nx">spec</span><span class="p">,</span>
        <span class="na">action</span><span class="p">:</span> <span class="nx">fn</span>
    <span class="p">}</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">actions</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">newAct</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">BaseController</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">RESTError</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">msg</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">restify</span><span class="p">[</span><span class="nx">type</span><span class="p">]){</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">restify</span><span class="p">[</span><span class="nx">type</span><span class="p">](</span><span class="nx">msg</span><span class="p">.</span><span class="nx">toString</span><span class="p">())</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Type "</span> <span class="o">+</span> <span class="nx">type</span> <span class="o">+</span> <span class="s2">" of error not found"</span><span class="p">.</span><span class="nx">red</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="c1">// Takes care of calling the "toHAL" method on every resource before writing it</span>
<span class="c1">// back to the clients</span>
<span class="nx">BaseController</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">writeHAL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">obj</span><span class="p">){</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">)){</span>
        <span class="kd">var</span> <span class="nx">newArr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">k</span><span class="p">){</span>
            <span class="nx">item</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">()</span>
            <span class="nx">newArr</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
        <span class="p">})</span>
        <span class="nx">obj</span> <span class="o">=</span> <span class="nx">halson</span> <span class="p">(</span><span class="nx">newArr</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">)</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">obj</span><span class="p">)</span><span class="nx">obj</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">BaseController</span>
</code></pre>
</div>

<p>Every controller extends this object, gaining access to the methods shown earlier. We’ll use basic prototypical inheritance, as you’ll see in a bit when we start listing the other controllers’ code. As for this one, let’s quickly go over the methods it exposes:</p>

<ul>
  <li><strong>setUpActions</strong>: This method is called upon instantiation of the controller; it is meant to add the actual routes to the HTTP server. This method is called during the initialization sequence for all controllers exported by the index.js file.</li>
  <li><strong>addAction</strong>: This method defines an action, which consists of the specs for that action and the actual function code. The specs are used by Swagger to create the documentation, but they’re also used by our code to set up the route; so there are bits inside the JSON spec that are also meant for the server, such as the path and method attributes.</li>
  <li><strong>RESTError</strong>: This is a simple wrapper method around all the error methods provided by Restify. It provides the benefit of cleaner code.</li>
  <li><strong>writeHAL</strong>: Every model defined (as you’ll see next) has a toHAL method, and the writeHAL methods take care of calling it for every model we’re trying to render. It basically centralizes the logic that deals with collections or simple objects, depending on what we’re trying to render.</li>
</ul>

<p><em>/controllers/books.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span>
    <span class="nx">BaseController</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./basecontroller"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">),</span>
    <span class="nx">swagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"swagger-node-restify"</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">Books</span><span class="p">(){}</span>

<span class="nx">Books</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseController</span><span class="p">()</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lib</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Books</span><span class="p">()</span>

    <span class="c1">// Helper function for the POST action</span>
    <span class="kd">function</span> <span class="nx">mergeStores</span><span class="p">(</span><span class="nx">list1</span><span class="p">,</span> <span class="nx">list2</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">stores1</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="kd">var</span> <span class="nx">stores2</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">list1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">st</span><span class="p">){</span> <span class="k">if</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">store</span><span class="p">)</span> <span class="nx">stores1</span><span class="p">[</span><span class="nx">st</span><span class="p">.</span><span class="nx">store</span><span class="p">]</span> <span class="o">=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">copies</span> <span class="p">})</span>
        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">list2</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">st</span><span class="p">){</span> <span class="k">if</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nx">store</span><span class="p">)</span> <span class="nx">stores2</span><span class="p">[</span><span class="nx">st</span><span class="p">.</span><span class="nx">store</span><span class="p">]</span> <span class="o">=</span> <span class="nx">st</span><span class="p">.</span><span class="nx">copies</span> <span class="p">})</span>
        <span class="kd">var</span> <span class="nx">stores</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">stores1</span><span class="p">,</span> <span class="nx">stores2</span><span class="p">)</span>
        <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">stores</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span><span class="nx">k</span><span class="p">){</span> <span class="k">return</span> <span class="p">{</span><span class="na">store</span><span class="p">:</span> <span class="nx">k</span><span class="p">,</span> <span class="na">copies</span><span class="p">:</span> <span class="nx">v</span><span class="p">}</span> <span class="p">})</span>
    <span class="p">}</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/books'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Returns the list of books'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span>
                    <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'q'</span><span class="p">,</span><span class="s1">'Search term'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">),</span>
                    <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'genre'</span><span class="p">,</span><span class="s1">'Filter by genre'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'responseClass'</span><span class="p">:</span><span class="s1">'Book'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'getBooks'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">criteria</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">expr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'.*'</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">.</span><span class="nx">q</span> <span class="o">+</span> <span class="s1">'.*'</span><span class="p">)</span>
            <span class="nx">criteria</span><span class="p">.</span><span class="nx">$or</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="na">title</span><span class="p">:</span><span class="nx">expr</span><span class="p">},</span>
                <span class="p">{</span><span class="na">isbn_code</span><span class="p">:</span><span class="nx">expr</span><span class="p">},</span>
                <span class="p">{</span><span class="na">description</span><span class="p">:</span><span class="nx">expr</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">genre</span><span class="p">){</span>
            <span class="nx">criteria</span><span class="p">.</span><span class="nx">genre</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">genre</span>
        <span class="p">}</span>
        <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Book'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">criteria</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'stores.store'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">books</span><span class="p">){</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">books</span><span class="p">)</span>
            <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/books/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the book'</span><span class="p">,</span><span class="s1">'int'</span><span class="p">)],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Returns the full data of a book'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'getBook'</span><span class="p">,</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Book"</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">id</span><span class="p">:</span><span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'stores'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'reviews'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">book</span><span class="p">){</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span> <span class="s1">'Book not found'</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">book</span><span class="p">)</span>
                <span class="p">})</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Missing book id'</span><span class="p">))</span> <span class="p">}</span>
    <span class="p">})</span>
    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/books'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">bodyParam</span><span class="p">(</span><span class="s1">'book'</span><span class="p">,</span><span class="s1">'JSON representation of the new book'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Adds a new book into the collection'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'newBook'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">req</span><span class="p">,</span><span class="nx">next</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">bookData</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">bookData</span><span class="p">){</span>
            <span class="nx">isbn</span> <span class="o">=</span> <span class="nx">bookData</span><span class="p">.</span><span class="nx">isbn_code</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Book"</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">isbn_code</span><span class="p">:</span><span class="nx">isbn</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">bookModel</span><span class="p">){</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">bookModel</span><span class="p">)</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Book"</span><span class="p">)(</span><span class="nx">bookData</span><span class="p">)</span>
                    <span class="k">else</span> <span class="nx">bookModel</span><span class="p">.</span><span class="nx">stores</span> <span class="o">=</span> <span class="nx">mergeStores</span><span class="p">(</span><span class="nx">bookModel</span><span class="p">.</span><span class="nx">stores</span><span class="p">,</span><span class="nx">bookData</span><span class="p">.</span><span class="nx">stores</span><span class="p">)</span>
                    <span class="nx">bookModel</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">book</span><span class="p">){</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                        <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">book</span><span class="p">)</span>
                    <span class="p">})</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span><span class="s1">'Missing content of book'</span><span class="p">))</span> <span class="p">}</span>
    <span class="p">})</span>
    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/books/{id}/authors'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The ID of the book'</span><span class="p">,</span><span class="s1">'int'</span><span class="p">)],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Returns the list of authors of one specific book'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'getAuthors'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Book"</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span><span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">book</span><span class="p">){</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span><span class="s1">'Book not found'</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">book</span><span class="p">.</span><span class="nx">authors</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Missing book id'</span><span class="p">))</span> <span class="p">}</span>
    <span class="p">})</span>
    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/books/{id}/reviews'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span> <span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'The Id of the book'</span><span class="p">,</span><span class="s1">'int'</span><span class="p">)</span> <span class="p">],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Returns the list of reviews of one specific book'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'getBooksReviews'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Book"</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span> <span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'reviews'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span> <span class="s1">'Book not found'</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">book</span><span class="p">.</span><span class="nx">reviews</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Missing book id'</span><span class="p">))</span> <span class="p">}</span>
    <span class="p">})</span>
    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/books/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'PUT'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span>
                    <span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'The Id of the book to update'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">),</span>
                    <span class="nx">swagger</span><span class="p">.</span><span class="nx">bodyParam</span><span class="p">(</span><span class="s1">'book'</span><span class="p">,</span> <span class="s1">'The data to change on the book'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Updates the information of one specific book'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'updateBook'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">){</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Book"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span> <span class="nx">id</span><span class="p">})</span>
            <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">book</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span><span class="s1">'Book not found'</span><span class="p">))</span>
                <span class="nx">book</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
                <span class="nx">book</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
                <span class="p">})</span>
            <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Invalid id received'</span><span class="p">))</span> <span class="p">}</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="nx">controller</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The code for this controller are the basic mechanics defined for this particular project on how to declare a controller and its actions.</p>

<p>We also have a special case for the POST action, which checks the ISBN of a new book to see if it is in stock at another store. If an ISBN already exists, the book is merged to all relevant stores; otherwise, a new record is created.</p>

<p>In theory, we’re creating a new function that inherits from the BaseController, which gives us the ability to add custom behavior on a specific controller. Reality is going to prove that we don’t really need such liberties, however. And we could very well do the same by instantiating the BaseController directly on every other controller file.</p>

<p>The controller files are required during initialization of the API, and when that happens, the lib object is passed to them, like so:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"/controllers/books.js"</span><span class="p">)(</span><span class="nx">lib</span><span class="p">)</span>
</code></pre>
</div>

<p>This means that the lib object is received by the export function, which is in charge of instantiating the new controller and adding actions to it to return it to the required code.
Here are some other interesting bits from the code:</p>

<ul>
  <li>The getBooks action shows how to do simple regular expression–based filtering with Mongoose.</li>
  <li>The update action is not actually using the update method from Mongoose, but instead loads the model using the extend method from the underscore, and finally calls the save method on the model. This is done for one simple reason: the update method doesn’t trigger any post hooks on the models, but the save method does, so if we wanted to add behavior to react to an update on the model, this would be the way to go about it.</li>
</ul>

<p><em>/controllers/stores.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span>
    <span class="nx">BaseController</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./basecontroller"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">),</span>
    <span class="nx">swagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"swagger-node-restify"</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">Stores</span><span class="p">(){}</span>

<span class="nx">Stores</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseController</span><span class="p">()</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lib</span><span class="p">){</span>


    <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Stores</span><span class="p">()</span>


    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span><span class="s1">'/stores'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s1">'Returns the list of stores'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'state'</span><span class="p">,</span><span class="s1">'Filter the list of stores by state'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'responseClass'</span><span class="p">:</span><span class="s1">'Store'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'getStores'</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">criteria</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">state</span><span class="p">)</span> <span class="nx">criteria</span><span class="p">.</span><span class="nx">state</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="s1">'i'</span><span class="p">)</span>
        <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Store'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">criteria</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="nx">list</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span>
            <span class="p">})</span>

    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/stores/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s1">'Returns the data of a store'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the store'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'responseClass'</span><span class="p">:</span><span class="s1">'Store'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'getStore'</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Store'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span><span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span><span class="s1">'Store not found'</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span><span class="s1">'Invalid id'</span><span class="p">))</span> <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/stores/{id}/books'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s1">'Returns the list of books of a store'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span>
            <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the store'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">),</span>
            <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'q'</span><span class="p">,</span> <span class="s1">'Search parameter for the books'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">),</span>
            <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'genre'</span><span class="p">,</span><span class="s1">'Filter results by genre'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="s1">'responseClass'</span><span class="p">:</span><span class="s1">'Book'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'getStoreBooks'</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">criteria</span> <span class="o">=</span> <span class="p">{</span><span class="na">stores</span><span class="p">:</span><span class="nx">id</span><span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="p">){</span>
                <span class="kd">var</span> <span class="nx">expr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'.*'</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="o">+</span><span class="s1">'.*'</span><span class="p">,</span><span class="s1">'i'</span><span class="p">)</span>
                <span class="nx">criteria</span><span class="p">.</span><span class="nx">$or</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">{</span><span class="na">title</span><span class="p">:</span><span class="nx">expr</span><span class="p">},</span>
                    <span class="p">{</span><span class="na">isbn_code</span><span class="p">:</span><span class="nx">expr</span><span class="p">},</span>
                    <span class="p">{</span><span class="na">description</span><span class="p">:</span><span class="nx">expr</span><span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">genre</span><span class="p">)</span> <span class="nx">criteria</span><span class="p">.</span><span class="nx">genre</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">genre</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Book'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">criteria</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span><span class="s1">'Invalid id'</span><span class="p">))}</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span><span class="s1">'/stores/{id}/employees'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s1">'Returns the list of employees working on a store'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the store'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'responseClass'</span><span class="p">:</span><span class="s1">'Employee'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'getStoreEmployees'</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Store'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span><span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span><span class="s1">'Store not found'</span><span class="p">))</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">data</span><span class="p">.</span><span class="nx">employees</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span><span class="s1">'Invalid id'</span><span class="p">))}</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/stores/{id}/booksales'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s1">'Returns the list of booksales done on a store'</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the store'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'responseClass'</span><span class="p">:</span><span class="s1">'BookSale'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'getStoresBookSales'</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Booksale'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">store</span><span class="p">:</span><span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'client'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'employee'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span><span class="s1">'Invalid id'</span><span class="p">))}</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span><span class="s1">'/stores'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'POST'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Adds a new store to the list'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'store'</span><span class="p">,</span><span class="s1">'The JSON data of the store'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'responseClass'</span><span class="p">:</span><span class="s1">'Store'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'newStore'</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">newStore</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Store'</span><span class="p">)(</span><span class="nx">data</span><span class="p">)</span>
            <span class="nx">newStore</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">store</span><span class="p">){</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">(</span><span class="nx">store</span><span class="p">))</span>
            <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span><span class="s1">'No data received'</span><span class="p">))}</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span><span class="s1">'/stores/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'PUT'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s2">"Updates a store's information"</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span>
            <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the store'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">),</span>
            <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'store'</span><span class="p">,</span><span class="s1">'The new information to update'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="s1">'responseClass'</span><span class="p">:</span><span class="s1">'Store'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'updateStore'</span><span class="p">,</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Store'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span><span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="nx">store</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">store</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span><span class="s1">'Store not found'</span><span class="p">))</span>
                    <span class="nx">store</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span>
                    <span class="nx">store</span><span class="p">.</span><span class="nx">save</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="nx">data</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
                    <span class="p">})</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span><span class="s1">'Invalid id'</span><span class="p">))}</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">controller</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The code for the Stores controller is very similar to that of the Books controller.</p>

<p>It does, however, have something of notice: the getStoresBookSales action clearly shows what happens when we don’t use a Hierarchical MVC model. I said that this is not a common case, so it would be fine for the purpose of this book, but it shows how separation of concerns is broken in the strictest of senses by acting over the model of another controller, instead of going through that other controller.</p>

<p>Given the added complexity that mechanism would imply to our code, we’re better off looking the other way for the time being.</p>

<p>Here are the remaining controllers. They don’t particularly show anything new compared to the
previous ones, so just look at the code and the occasional code comment.</p>

<p><em>/controllers/authors.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span>
    <span class="nx">BaseController</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./basecontroller'</span><span class="p">),</span>
    <span class="nx">swagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'swagger-node-restify'</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">BookSales</span><span class="p">(){}</span>

<span class="nx">BookSales</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseController</span><span class="p">()</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lib</span><span class="p">){</span>

    <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BookSales</span><span class="p">()</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span><span class="s1">'/authors'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s1">'Returns the list of authors across all sites'</span><span class="p">,</span>
        <span class="s1">'responsClass'</span><span class="p">:</span><span class="s1">'Author'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'getAuthors'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'q'</span><span class="p">,</span><span class="s1">'Search parameter'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)]</span>
    <span class="p">},(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="kd">var</span> <span class="nx">criteria</span> <span class="o">=</span> <span class="p">{},</span>
            <span class="nx">filterByGenre</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">||</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">genre</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">expr</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'.*'</span><span class="o">+</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">q</span><span class="o">+</span><span class="s1">'.*'</span><span class="p">,</span><span class="s1">'i'</span><span class="p">)</span>
            <span class="nx">criteria</span><span class="p">.</span><span class="nx">$or</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="na">name</span><span class="p">:</span><span class="nx">expr</span><span class="p">},</span>
                <span class="p">{</span><span class="na">description</span><span class="p">:</span><span class="nx">expr</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">filterByGenre</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Book'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="na">genre</span><span class="p">:</span><span class="nx">filterByGenre</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span><span class="nx">books</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                    <span class="nx">findAuthors</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span><span class="p">(</span><span class="nx">books</span><span class="p">,</span><span class="s1">'_id'</span><span class="p">))</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">findAuthors</span><span class="p">()</span> <span class="p">}</span>
        <span class="kd">function</span> <span class="nx">findAuthors</span><span class="p">(</span><span class="nx">bookIds</span><span class="p">){</span>
            <span class="k">if</span><span class="p">(</span><span class="nx">bookIds</span><span class="p">)</span> <span class="nx">criteria</span><span class="p">.</span><span class="nx">books</span> <span class="o">=</span> <span class="p">{</span><span class="na">$in</span><span class="p">:</span><span class="nx">bookIds</span><span class="p">}</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Author'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">criteria</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">authors</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">authors</span><span class="p">)</span>
                <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span><span class="s1">'/authors/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s1">'Returns all the data from one specific author'</span><span class="p">,</span>
        <span class="s1">'responsClass'</span><span class="p">:</span><span class="s1">'Author'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'getAuthor'</span>
    <span class="p">},(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Author'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span> <span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">author</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span><span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">author</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span> <span class="s1">'Author not found'</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">author</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Missing author id'</span><span class="p">))</span> <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span><span class="s1">'/authors'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'POST'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s1">'Adds a new author'</span><span class="p">,</span>
        <span class="s1">'responsClass'</span><span class="p">:</span><span class="s1">'Author'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'addAuthor'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">bodyParam</span><span class="p">(</span><span class="s1">'author'</span><span class="p">,</span><span class="s1">'JSON representation of the data'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)]</span>
    <span class="p">},(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">body</span><span class="p">){</span>
            <span class="kd">var</span> <span class="nx">newAuthor</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Author'</span><span class="p">)(</span><span class="nx">body</span><span class="p">)</span>
            <span class="nx">newAuthor</span><span class="p">.</span><span class="nx">save</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">author</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">author</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Missing author id'</span><span class="p">))</span> <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span><span class="s1">'/authors/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'PUT'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s2">"UPDATES an author's information"</span><span class="p">,</span>
        <span class="s1">'responsClass'</span><span class="p">:</span><span class="s1">'Author'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'updateAuthor'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:[</span>
            <span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the author'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">),</span>
            <span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'author'</span><span class="p">,</span><span class="s1">'The new information to update'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">,</span>
            <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Author"</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span> <span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">author</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">author</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span><span class="s1">'Author not found'</span><span class="p">))</span>
                    <span class="nx">author</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">author</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
                    <span class="nx">author</span><span class="p">.</span><span class="nx">save</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
                        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                        <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">(</span><span class="nx">data</span><span class="p">))</span>
                    <span class="p">})</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Invalid id received'</span><span class="p">))</span> <span class="p">}</span>

    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span><span class="s1">'/authors/{id}/books'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span><span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span><span class="s1">'Returns the data from all the books of one specific author'</span><span class="p">,</span>
        <span class="s1">'responsClass'</span><span class="p">:</span><span class="s1">'Book'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span><span class="s1">'getAuthorsBook'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the author'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)]</span>
    <span class="p">},</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">id</span><span class="p">){</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Author'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span> <span class="nx">id</span><span class="p">})</span>
                <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">((</span><span class="nx">err</span><span class="p">,</span> <span class="nx">author</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                    <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">author</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span> <span class="s1">'Author not found'</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">author</span><span class="p">.</span><span class="nx">books</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Missing author id'</span><span class="p">))</span> <span class="p">}</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">controller</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/controllers/booksales.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code> <span class="kd">var</span> <span class="nx">BaseController</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./basecontroller"</span><span class="p">),</span>
     <span class="nx">swagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"swagger-node-restify"</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">BookSales</span><span class="p">()</span> <span class="p">{}</span>

<span class="nx">BookSales</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseController</span><span class="p">()</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lib</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BookSales</span><span class="p">();</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
           <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/booksales'</span><span class="p">,</span>
           <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
           <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Returns the list of book sales'</span><span class="p">,</span>
           <span class="s1">'responseClass'</span><span class="p">:</span> <span class="s1">'BookSale'</span><span class="p">,</span>
           <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'getBookSales'</span><span class="p">,</span>
           <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span>
               <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'start_date'</span><span class="p">,</span> <span class="s1">'Filter sales done after (or on) this date'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
               <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'end_date'</span><span class="p">,</span> <span class="s1">'Filter sales done on or before this date'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
               <span class="nx">swagger</span><span class="p">.</span><span class="nx">queryParam</span><span class="p">(</span><span class="s1">'store_id'</span><span class="p">,</span> <span class="s1">'Filter sales done  on this store'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)</span>
            <span class="p">]</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
        <span class="kd">var</span> <span class="nx">criteria</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">start_date</span><span class="p">)</span> <span class="nx">criteria</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="p">{</span><span class="na">$gte</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">start_date</span><span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">end_date</span><span class="p">)</span> <span class="nx">criteria</span><span class="p">.</span><span class="nx">date</span> <span class="o">=</span> <span class="p">{</span><span class="na">$lte</span><span class="p">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">end_date</span><span class="p">}</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">store_id</span><span class="p">)</span> <span class="nx">criteria</span><span class="p">.</span><span class="nx">store</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">store_id</span>
        <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Booksale"</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="nx">criteria</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'books'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'client'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'employee'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">populate</span><span class="p">(</span><span class="s1">'store'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sales</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">sales</span><span class="p">)</span>
            <span class="p">})</span>
    <span class="p">})</span>
    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/booksales'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span> <span class="nx">swagger</span><span class="p">.</span><span class="nx">bodyParam</span><span class="p">(</span><span class="s1">'booksale'</span><span class="p">,</span> <span class="s1">'JSON representation of the new booksale'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)</span> <span class="p">],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Records a new booksale'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'newBookSale'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">newSale</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Booksale"</span><span class="p">)(</span><span class="nx">body</span><span class="p">)</span>
            <span class="nx">newSale</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">sale</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">sale</span><span class="p">)</span>
            <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Missing json data'</span><span class="p">))}</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="nx">controller</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/controllers/clientreviews.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code> <span class="kd">var</span>
    <span class="nx">BaseController</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./basecontroller"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">),</span>
    <span class="nx">swagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"swagger-node-restify"</span><span class="p">)</span>

 <span class="kd">function</span> <span class="nx">ClientReviews</span><span class="p">()</span> <span class="p">{}</span>

 <span class="nx">ClientReviews</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseController</span><span class="p">()</span>

 <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lib</span><span class="p">)</span> <span class="p">{</span>
     <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ClientReviews</span><span class="p">();</span>

     <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
         <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/clientreviews'</span><span class="p">,</span>
         <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
         <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Adds a new client review to a book'</span><span class="p">,</span>
         <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">bodyParam</span><span class="p">(</span><span class="s1">'review'</span><span class="p">,</span> <span class="s1">'The JSON representation of the review'</span><span class="p">,</span>  <span class="s1">'string'</span><span class="p">)],</span>
         <span class="s1">'responseClass'</span><span class="p">:</span> <span class="s1">'ClientReview'</span><span class="p">,</span>
         <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'addClientReview'</span>
     <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">body</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
         <span class="k">if</span><span class="p">(</span><span class="nx">body</span><span class="p">)</span> <span class="p">{</span>
             <span class="kd">var</span> <span class="nx">newReview</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'ClientReview'</span><span class="p">)(</span><span class="nx">body</span><span class="p">)</span>
             <span class="nx">newReview</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">rev</span><span class="p">)</span> <span class="p">{</span>
                 <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                 <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">rev</span><span class="p">)</span>
             <span class="p">})</span>
         <span class="p">}</span>
     <span class="p">})</span>
     <span class="k">return</span> <span class="nx">controller</span>
 <span class="p">}</span>
</code></pre>
</div>

<p><em>/controllers/clients.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">BaseController</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./basecontroller"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">),</span>
    <span class="nx">swagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"swagger-node-restify"</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">Clients</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">Clients</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseController</span><span class="p">()</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lib</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Clients</span><span class="p">();</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/clients'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Returns the list of clients ordered by name'</span><span class="p">,</span>
        <span class="s1">'responsClass'</span><span class="p">:</span> <span class="s1">'Client'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'getClients'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Client'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">find</span><span class="p">()</span>
            <span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="s1">'name'</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">clients</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">clients</span><span class="p">)</span>
            <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/clients'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">bodyParam</span><span class="p">(</span><span class="s1">'client'</span><span class="p">,</span> <span class="s1">'The JSON representation of the client'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Adds a new client to the database'</span><span class="p">,</span>
        <span class="s1">'responsClass'</span><span class="p">:</span> <span class="s1">'Client'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'addClient'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">newClient</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
        <span class="kd">var</span> <span class="nx">newClientModel</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Client'</span><span class="p">)(</span><span class="nx">newClient</span><span class="p">)</span>
        <span class="nx">newClientModel</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
            <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/clients/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'The id of the client'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Returns the data of one client'</span><span class="p">,</span>
        <span class="s1">'responsClass'</span><span class="p">:</span> <span class="s1">'Client'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'getClient'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">id</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Client'</span><span class="p">)</span>
                <span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
                    <span class="na">_id</span><span class="p">:</span> <span class="nx">id</span>
                <span class="p">})</span>
                <span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">client</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span> <span class="s1">'The client id cannot be found'</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span>
                <span class="p">})</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Invalid client id'</span><span class="p">))</span>
        <span class="p">}</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/clients/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'PUT'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span>
            <span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span> <span class="s1">'The id of the client'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">),</span>
            <span class="nx">swagger</span><span class="p">.</span><span class="nx">bodyParam</span><span class="p">(</span><span class="s1">'client'</span><span class="p">,</span> <span class="s1">'The content to overwrite'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)</span>
        <span class="p">],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Updates the data of one client'</span><span class="p">,</span>
        <span class="s1">'responsClass'</span><span class="p">:</span> <span class="s1">'Client'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'updateClient'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">id</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Invalid id'</span><span class="p">))</span>
        <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Client'</span><span class="p">)</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
                <span class="na">_id</span><span class="p">:</span> <span class="nx">id</span>
            <span class="p">})</span>
            <span class="nx">model</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                <span class="nx">client</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">client</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
                <span class="nx">client</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">newClient</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                    <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">newClient</span><span class="p">)</span>
                <span class="p">})</span>
            <span class="p">})</span>
        <span class="p">}</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="nx">controller</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/controllers/employees.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span>
    <span class="nx">BaseController</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./basecontroller"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">),</span>
    <span class="nx">swagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"swagger-node-restify"</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">Employees</span><span class="p">()</span> <span class="p">{}</span>
<span class="nx">Employees</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BaseController</span><span class="p">()</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">lib</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">controller</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Employees</span><span class="p">();</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/employees'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Returns the list of employees across all stores'</span><span class="p">,</span>
        <span class="s1">'responseClass'</span><span class="p">:</span> <span class="s1">'Employee'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'getEmployees'</span>
    <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Employee'</span><span class="p">).</span><span class="nx">find</span><span class="p">().</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
            <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">list</span><span class="p">)</span>
        <span class="p">})</span>
    <span class="p">})</span>

    <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/employees/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'GET'</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the employee'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Returns the data of an employee'</span><span class="p">,</span>
        <span class="s1">'responseClass'</span><span class="p">:</span> <span class="s1">'Employee'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'getEmployee'</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">id</span><span class="p">)</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Invalid id'</span><span class="p">))</span>
      <span class="k">else</span> <span class="p">{</span>
          <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Employee'</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span> <span class="nx">id</span><span class="p">}).</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">empl</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
              <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">empl</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'ResourceNotFoundError'</span><span class="p">,</span> <span class="s1">'Not found'</span><span class="p">))</span>
              <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">empl</span><span class="p">)</span>
          <span class="p">})</span>
      <span class="p">}</span>
  <span class="p">})</span>

  <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
      <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/employees'</span><span class="p">,</span>
      <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'POST'</span><span class="p">,</span>
      <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span><span class="nx">swagger</span><span class="p">.</span><span class="nx">bodyParam</span><span class="p">(</span><span class="s1">'employee'</span><span class="p">,</span> <span class="s1">'The JSON data of the employee'</span><span class="p">,</span>
      <span class="s1">'string'</span><span class="p">)],</span>
      <span class="s1">'summary'</span><span class="p">:</span> <span class="s1">'Adds a new employee to the list'</span><span class="p">,</span>
      <span class="s1">'responseClass'</span><span class="p">:</span> <span class="s1">'Employee'</span><span class="p">,</span>
      <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'newEmployee'</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">data</span><span class="p">)</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'No data received'</span><span class="p">))</span>
      <span class="k">else</span> <span class="p">{</span>
          <span class="kd">var</span> <span class="nx">newEmployee</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Employee'</span><span class="p">)(</span><span class="nx">data</span><span class="p">)</span>
          <span class="nx">newEmployee</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">emp</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
              <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">emp</span><span class="p">)</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">})</span>

  <span class="nx">controller</span><span class="p">.</span><span class="nx">addAction</span><span class="p">({</span>
        <span class="s1">'path'</span><span class="p">:</span> <span class="s1">'/employees/{id}'</span><span class="p">,</span>
        <span class="s1">'method'</span><span class="p">:</span> <span class="s1">'PUT'</span><span class="p">,</span>
        <span class="s1">'summary'</span><span class="p">:</span> <span class="s2">"UPDATES an employee's information"</span><span class="p">,</span>
        <span class="s1">'params'</span><span class="p">:</span> <span class="p">[</span>
                <span class="nx">swagger</span><span class="p">.</span><span class="nx">pathParam</span><span class="p">(</span><span class="s1">'id'</span><span class="p">,</span><span class="s1">'The id of the employee'</span><span class="p">,</span><span class="s1">'string'</span><span class="p">),</span>
                <span class="nx">swagger</span><span class="p">.</span><span class="nx">bodyParam</span><span class="p">(</span><span class="s1">'employee'</span><span class="p">,</span> <span class="s1">'The new information to update'</span><span class="p">,</span> <span class="s1">'string'</span><span class="p">)],</span>
        <span class="s1">'responseClass'</span><span class="p">:</span> <span class="s1">'Employee'</span><span class="p">,</span>
        <span class="s1">'nickname'</span><span class="p">:</span> <span class="s1">'updateEmployee'</span>
  <span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span>
      <span class="kd">var</span> <span class="nx">id</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">id</span>
      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">id</span><span class="p">)</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InvalidArgumentError'</span><span class="p">,</span> <span class="s1">'Invalid id'</span><span class="p">))</span>
      <span class="k">else</span> <span class="p">{</span>
          <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s2">"Employee"</span><span class="p">).</span><span class="nx">findOne</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span> <span class="nx">id</span><span class="p">}).</span><span class="nx">exec</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">emp</span><span class="p">)</span> <span class="p">{</span>
              <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
              <span class="nx">emp</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">emp</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span>
              <span class="nx">emp</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">employee</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">controller</span><span class="p">.</span><span class="nx">RESTError</span><span class="p">(</span><span class="s1">'InternalServerError'</span><span class="p">,</span> <span class="nx">err</span><span class="p">))</span>
                  <span class="nx">controller</span><span class="p">.</span><span class="nx">writeHAL</span><span class="p">(</span><span class="nx">res</span><span class="p">,</span> <span class="nx">employee</span><span class="p">)</span>
              <span class="p">})</span>
          <span class="p">})</span>
      <span class="p">}</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="nx">controller</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="lib">lib</h3>

<p>The lib folder contains all sorts of helper functions and utilities that were just too small to be put into a separate folder, but important and generic enough to be used in several places of the code.</p>

<p><em>/lib/index.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">lib</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">helpers</span><span class="p">:</span>            <span class="nx">require</span><span class="p">(</span><span class="s2">"./helpers"</span><span class="p">),</span>
    <span class="na">config</span><span class="p">:</span>             <span class="nx">require</span><span class="p">(</span><span class="s2">"./config"</span><span class="p">),</span>
    <span class="na">controllers</span><span class="p">:</span>        <span class="nx">require</span><span class="p">(</span><span class="s2">"../controllers"</span><span class="p">),</span>
    <span class="na">schemas</span><span class="p">:</span>            <span class="nx">require</span><span class="p">(</span><span class="s2">"../schemas"</span><span class="p">),</span>
    <span class="na">schemaValidator</span><span class="p">:</span>    <span class="nx">require</span><span class="p">(</span><span class="s2">"./schemaValidator"</span><span class="p">),</span>
    <span class="na">db</span><span class="p">:</span>                 <span class="nx">require</span><span class="p">(</span><span class="s2">"./db"</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">lib</span>
</code></pre>
</div>

<p>This file is supposed to act as the single point of contact between the outside world (the rest of the project) and the inside world (all of the mini-modules grouped within this folder). There is nothing special about it. It just requires everything and exports using predefined keys.</p>

<p><em>/lib/helpers.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">halson</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"halson"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">makeHAL</span><span class="p">:</span>        <span class="nx">makeHAL</span><span class="p">,</span>
    <span class="na">setupRoutes</span><span class="p">:</span>    <span class="nx">setupRoutes</span><span class="p">,</span>
    <span class="na">validateKey</span><span class="p">:</span>    <span class="nx">validateKey</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">setupRoutes</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span><span class="nx">swagger</span><span class="p">,</span><span class="nx">lib</span><span class="p">){</span>
    <span class="k">for</span><span class="p">(</span><span class="nx">controller</span> <span class="k">in</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">controllers</span><span class="p">){</span>
        <span class="nx">cont</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">controllers</span><span class="p">[</span><span class="nx">controller</span><span class="p">](</span><span class="nx">lib</span><span class="p">)</span>
        <span class="nx">cont</span><span class="p">.</span><span class="nx">setUpActions</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span><span class="nx">swagger</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Sign in every request and compare it</span>
<span class="c1">// against the key sent by the client, this way</span>
<span class="c1">// we make shure its authentic</span>
<span class="kd">function</span> <span class="nx">validateKey</span><span class="p">(</span><span class="nx">hmacdata</span><span class="p">,</span><span class="nx">key</span><span class="p">,</span><span class="nx">lib</span><span class="p">){</span>
    <span class="c1">// This is for testing the swagger-ui, should be removed after development</span>
    <span class="c1">// to avoid possible security problem</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">key</span> <span class="o">==</span> <span class="mi">777</span><span class="p">)</span> <span class="k">return</span> <span class="kc">true</span>
    <span class="kd">var</span> <span class="nx">hmac</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"crypto"</span><span class="p">).</span><span class="nx">createHmac</span><span class="p">(</span><span class="s2">"md5"</span><span class="p">,</span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">secretKey</span><span class="p">).</span><span class="nx">update</span><span class="p">(</span><span class="nx">hmacdata</span><span class="p">).</span><span class="nx">digest</span><span class="p">(</span><span class="s2">"hex"</span><span class="p">)</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hmac</span><span class="p">)</span> <span class="c1">// remove this line</span>
    <span class="k">return</span> <span class="nx">hmac</span> <span class="o">==</span> <span class="nx">key</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">makeHAL</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span><span class="nx">links</span><span class="p">,</span><span class="nx">embed</span><span class="p">){</span>
    <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="nx">halson</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">links</span> <span class="o">&amp;&amp;</span> <span class="nx">links</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">links</span><span class="p">,(</span><span class="nx">lnk</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">addLink</span><span class="p">(</span><span class="nx">lnk</span><span class="p">.</span><span class="nx">name</span><span class="p">,{</span><span class="na">href</span><span class="p">:</span><span class="nx">lnk</span><span class="p">.</span><span class="nx">href</span><span class="p">,</span><span class="na">title</span><span class="p">:</span><span class="nx">lnk</span><span class="p">.</span><span class="nx">title</span> <span class="o">||</span> <span class="s1">''</span><span class="p">})</span> <span class="p">})</span> <span class="p">}</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">embed</span> <span class="o">&amp;&amp;</span> <span class="nx">embed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">embed</span><span class="p">,(</span><span class="nx">item</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">addEmbed</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span><span class="nx">item</span><span class="p">.</span><span class="nx">data</span><span class="p">)})</span> <span class="p">}</span>
    <span class="k">return</span> <span class="nx">obj</span>
<span class="p">}</span>
</code></pre>
</div>

<p>Just as the modules exported by the index.js file are too small to merit their own folder, these functions are too small and particular to merit their own module, so instead they are grouped here, inside the helpers module. The functions are meant to be of use (hence, the name “helpers”) throughout the entire project:</p>

<ul>
  <li>
    <p><strong>setupRoutes</strong>: This function is called from within the project’s main file during boot-up time. It’s meant to initialize all controllers, which in turn adds the actual route’s code to the HTTP server.</p>
  </li>
  <li>
    <p><strong>validateKey</strong>: This function contains the code to validate the request by recalculating the HMAC key. And as mentioned earlier, it contains the exception to the rule, allowing any request to validate if the key sent is 777.</p>
  </li>
  <li>
    <p><strong>makeHAL</strong>: This function turns any type of object into a HAL JSON object ready to be rendered. This particular function is heavily used from within the models’ code.</p>
  </li>
</ul>

<p><em>/lib/schemaValidator.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">tv4</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"tv4"</span><span class="p">),</span>
    <span class="nx">formats</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"tv4-formats"</span><span class="p">),</span>
    <span class="nx">schemas</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../request_schemas/"</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">validateRequest</span><span class="p">:</span> <span class="nx">validate</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">validate</span> <span class="p">(</span><span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="p">{</span><span class="na">valid</span><span class="p">:</span> <span class="kc">true</span><span class="p">}</span>
    <span class="nx">tv4</span><span class="p">.</span><span class="nx">addFormat</span><span class="p">(</span><span class="nx">formats</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">schemaKey</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">route</span> <span class="p">?</span> <span class="nx">req</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">path</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">replace</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span> <span class="s2">""</span><span class="p">)</span> <span class="p">:</span> <span class="s1">''</span>
    <span class="kd">var</span> <span class="nx">actionKey</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">route</span><span class="p">.</span><span class="nx">name</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">schemas</span><span class="p">[</span><span class="nx">schemaKey</span><span class="p">]){</span>
        <span class="kd">var</span> <span class="nx">mySchema</span> <span class="o">=</span> <span class="nx">schemas</span><span class="p">[</span><span class="nx">schemaKey</span><span class="p">][</span><span class="nx">actionKey</span><span class="p">]</span>
        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="kc">null</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">mySchema</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">switch</span><span class="p">(</span><span class="nx">mySchema</span><span class="p">.</span><span class="nx">validate</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="s1">'params'</span><span class="err">:</span>
                    <span class="nx">data</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span>
                    <span class="k">break</span>
            <span class="p">}</span>
            <span class="nx">res</span> <span class="o">=</span> <span class="nx">tv4</span><span class="p">.</span><span class="nx">validateMultiple</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">mySchema</span><span class="p">.</span><span class="nx">s</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">res</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This file has the code that validates any request against a JSON Schema that we define.</p>

<p>The only function of interest is the validate function, which validates the request object. It also counts on a predefined structure inside the request, which is added by Swagger (the route attribute).</p>

<p>As you might’ve guessed from the preceding code, the validation of a request is optional; not every request is being validated. And right now, only query parameters are validated, but this can be extended by simply adding a new case to the switch statement.</p>

<p>This function works with the premise of “convention over configuration,” which means that if you set up everything “right,” then you don’t have to do much. In our particular case, we’re looking inside the request_ schemas folder to load a set of predefined schemas, which have a very specific format. In that format we find the name of the action (the nickname that we set up) to validate and the portion of the request we want to validate.</p>

<p>In our particular function, we’re only validating query parameters for things such as invalid formats and so forth. The only request we have set up to validate right now is the BookSales listing action; but if we wanted to add a new validation, it would just be a matter of adding a new schema—no programming required.</p>

<p><em>/lib/db.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span>
    <span class="nx">config</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./config"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">),</span>
    <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">),</span>
    <span class="nx">Schema</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">Schema</span>

<span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">cachedModels</span><span class="p">:</span> <span class="p">{},</span>
    <span class="na">getModelFromSchema</span><span class="p">:</span> <span class="nx">getModelFromSchema</span><span class="p">,</span>
    <span class="na">model</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">mname</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">models</span><span class="p">[</span><span class="nx">mname</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="nl">connect</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="s2">"/"</span> <span class="o">+</span> <span class="nx">config</span><span class="p">.</span><span class="nx">database</span><span class="p">.</span><span class="nx">dbname</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">connection</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">connection</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'error'</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'open'</span><span class="p">,</span> <span class="nx">cb</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">obj</span><span class="p">.</span><span class="nx">models</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../models/"</span><span class="p">)(</span><span class="nx">obj</span><span class="p">)</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">obj</span>

<span class="kd">function</span> <span class="nx">translateComplexType</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">strType</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="kd">var</span> <span class="nx">type</span> <span class="o">=</span> <span class="nx">strType</span> <span class="o">||</span> <span class="nx">v</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span>

    <span class="k">switch</span> <span class="p">(</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">'array'</span><span class="p">:</span>
            <span class="nx">tmp</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class="s1">'items'</span><span class="p">][</span><span class="s1">'$ref'</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">tmp</span><span class="p">.</span><span class="nx">push</span><span class="p">({</span>
                    <span class="na">type</span><span class="p">:</span> <span class="nx">Schema</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
                    <span class="na">ref</span><span class="p">:</span> <span class="nx">v</span><span class="p">[</span><span class="s1">'items'</span><span class="p">][</span><span class="s1">'$ref'</span><span class="p">]</span>
                <span class="p">})</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="kd">var</span> <span class="nx">originalType</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="s1">'items'</span><span class="p">][</span><span class="s1">'type'</span><span class="p">]</span>
                <span class="nx">v</span><span class="p">[</span><span class="s1">'items'</span><span class="p">][</span><span class="s1">'type'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">translateTypeToJs</span><span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class="s1">'items'</span><span class="p">]</span>
                    <span class="p">[</span><span class="s1">'type'</span><span class="p">])</span>
                <span class="nx">tmp</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">translateComplexType</span><span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class="s1">'items'</span><span class="p">],</span> <span class="nx">originalType</span><span class="p">))</span>
            <span class="p">}</span>
            <span class="k">break</span>

        <span class="k">case</span> <span class="s1">'object'</span><span class="p">:</span>
            <span class="nx">tmp</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="kd">var</span> <span class="nx">props</span> <span class="o">=</span> <span class="nx">v</span><span class="p">[</span><span class="s1">'properties'</span><span class="p">]</span>
            <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">props</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">k</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s1">'$ref'</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">tmp</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="na">type</span><span class="p">:</span> <span class="nx">Schema</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
                        <span class="na">ref</span><span class="p">:</span> <span class="nx">data</span><span class="p">[</span><span class="s1">'$ref'</span><span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="nx">tmp</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">translateTypeToJs</span><span class="p">(</span><span class="nx">data</span><span class="p">[</span><span class="s1">'type'</span><span class="p">])</span>
                <span class="p">}</span>
            <span class="p">})</span>
            <span class="k">break</span>

        <span class="na">default</span><span class="p">:</span>
            <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">v</span>
            <span class="nx">tmp</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span> <span class="o">=</span> <span class="nx">translateTypeToJs</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span>
            <span class="k">break</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">tmp</span>
<span class="p">}</span>

<span class="c1">// Turns the JSON Schema into a Mongoose schema</span>
<span class="kd">function</span> <span class="nx">getModelFromSchema</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="nx">schema</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
        <span class="na">schema</span><span class="p">:</span> <span class="p">{}</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">newSchema</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="kd">var</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="kc">null</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">schema</span><span class="p">.</span><span class="nx">properties</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">propName</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">v</span><span class="p">[</span><span class="s1">'$ref'</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tmp</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">type</span><span class="p">:</span> <span class="nx">Schema</span><span class="p">.</span><span class="nx">ObjectId</span><span class="p">,</span>
                <span class="na">ref</span><span class="p">:</span> <span class="nx">v</span><span class="p">[</span><span class="s1">'$ref'</span><span class="p">]</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="nx">tmp</span> <span class="o">=</span> <span class="nx">translateComplexType</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="p">}</span>
        <span class="nx">newSchema</span><span class="p">[</span><span class="nx">propName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">tmp</span>
    <span class="p">})</span>
    <span class="nx">data</span><span class="p">.</span><span class="nx">schema</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Schema</span><span class="p">(</span><span class="nx">newSchema</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">data</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">translateTypeToJs</span><span class="p">(</span><span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s1">'int'</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span>  <span class="nx">t</span> <span class="o">=</span> <span class="s2">"number"</span>
    <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="nx">t</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="nx">toUpperCase</span><span class="p">()</span> <span class="o">+</span> <span class="nx">t</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="p">}</span>
</code></pre>
</div>

<p>This file contains some interesting functions that are used a lot from the models’ code.</p>

<p>The schemas used with Swagger can potentially be reused to do other things, such
as defining the models’ schemas. But to do this, we need a function to translate the standard JSON Schema into the nonstandard JSON format required by Mongoose to define a model. This is where the getModelFromSchema function comes into play; its code is meant to go over the structure of the JSON Schema and create a new, simpler JSON structure to be used as a Mongoose Schema.
The other functions are more straightforward:</p>

<ul>
  <li><strong>connect</strong>: Connects to the database server and sets up the callbacks for both error and success cases.</li>
  <li><strong>model</strong>: Accesses the model from outside. We could just directly access the models using the object models, but it’s always a good idea to provide a wrapper in case you ever need to add extra behaviors (such as checking for errors).</li>
</ul>

<p><em>/lib/config.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">secretKey</span><span class="p">:</span> <span class="s1">'this is a secret key, right here'</span><span class="p">,</span>
    <span class="na">server</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">name</span><span class="p">:</span> <span class="s1">'ComeNRead API'</span><span class="p">,</span>
        <span class="na">version</span><span class="p">:</span> <span class="s1">'1.0.0'</span><span class="p">,</span>
        <span class="na">port</span><span class="p">:</span> <span class="mi">9000</span>
    <span class="p">},</span>
    <span class="na">database</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">host</span><span class="p">:</span> <span class="s1">'mongodb://localhost'</span><span class="p">,</span>
        <span class="na">dbname</span><span class="p">:</span> <span class="s1">'comenread'</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="models">models</h3>

<p>This folder contains the actual code of each model. The definition of these resources won’t be found in these files because they’re only meant to define behavior. The actual properties are defined in the schemas folder (which, is being used both by the models and Swagger).</p>

<p><em>/models/index.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">"Book"</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./book"</span><span class="p">)(</span><span class="nx">db</span><span class="p">),</span>
        <span class="s2">"Booksale"</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./booksale"</span><span class="p">)(</span><span class="nx">db</span><span class="p">),</span>
        <span class="s2">"ClientReview"</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./clientreview"</span><span class="p">)(</span><span class="nx">db</span><span class="p">),</span>
        <span class="s2">"Client"</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./client"</span><span class="p">)(</span><span class="nx">db</span><span class="p">),</span>
        <span class="s2">"Employee"</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./employee"</span><span class="p">)(</span><span class="nx">db</span><span class="p">),</span>
        <span class="s2">"Store"</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./store"</span><span class="p">)(</span><span class="nx">db</span><span class="p">),</span>
        <span class="s2">"Author"</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./author"</span><span class="p">)(</span><span class="nx">db</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>As in the other folders, the index.js file allows us to require every model at once, and treat this folder like a module itself.</p>

<p>The other thing of note here is the passing of the db object to every model, so that they can access the getModelFromSchema function.</p>

<p><em>/models/author.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code> <span class="kd">var</span>
     <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">),</span>
     <span class="nx">jsonSelect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose-json-select'</span><span class="p">),</span>
     <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../lib/helpers"</span><span class="p">),</span>
     <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">)</span>

 <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
     <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../schemas/author.js"</span><span class="p">)</span>
     <span class="kd">var</span> <span class="nx">modelDef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getModelFromSchema</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
     <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">jsonSelect</span><span class="p">,</span> <span class="s1">'-books'</span><span class="p">)</span>
     <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">toHAL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">halObj</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">makeHAL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="p">[{</span>
             <span class="na">name</span><span class="p">:</span> <span class="s1">'books'</span><span class="p">,</span>
             <span class="s1">'href'</span><span class="p">:</span> <span class="s1">'/authors/'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">'/books'</span><span class="p">,</span>
             <span class="s1">'title'</span><span class="p">:</span> <span class="s1">'Books'</span>
         <span class="p">}])</span>
         <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
             <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
                 <span class="nx">halObj</span><span class="p">.</span><span class="nx">addEmbed</span><span class="p">(</span><span class="s1">'books'</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">,</span>
                     <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
                         <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">()</span>
                     <span class="p">}))</span>
             <span class="p">}</span>
         <span class="p">}</span>
         <span class="k">return</span> <span class="nx">halObj</span>
     <span class="p">}</span>
     <span class="k">return</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">modelDef</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">)</span>
 <span class="p">}</span>
</code></pre>
</div>

<p>The code of the Author model shows the basic mechanics of loading the JSON Schema, transforming it into a Mongoose Schema, defining the custom behavior, and finally returning a new model.
The following defines the main custom behaviors:</p>

<ul>
  <li>The jsonSelect model allows us to define the attributes to add to or remove
from the object when turning it into a JSON. We want to remove the embedded objects from the JSON representation, because they will be added to the HAL JSON representation as embedded objects, rather than being part of the main object.</li>
  <li>The toHAL method takes care of returning the representation of the resource in JSON HAL format.</li>
  <li>The links associated to the main object are defined manually. We could improve this by further customizing the code for the loading and transformation of the JSON Schemas of the models.</li>
</ul>

<p><strong>The code below determine if the model has populated a reference, or if it is simply the id of the referenced object</strong></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">//...</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The following is the rest of the code inside the models folder, as you can appreciate, the same mechanics are duplicated on every case.</p>

<p><em>/models/book.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">),</span>
    <span class="nx">jsonSelect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose-json-select'</span><span class="p">),</span>
    <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../lib/helpers"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../schemas/book.js"</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">modelDef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getModelFromSchema</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">jsonSelect</span><span class="p">,</span> <span class="s1">'-stores -authors'</span><span class="p">)</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">toHAL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">halObj</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">makeHAL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="p">[{</span>
            <span class="na">name</span><span class="p">:</span> <span class="s1">'reviews'</span><span class="p">,</span>
            <span class="na">href</span><span class="p">:</span> <span class="s1">'/books/'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">'/reviews'</span><span class="p">,</span>
            <span class="na">title</span><span class="p">:</span> <span class="s1">'Reviews'</span>
        <span class="p">}])</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stores</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stores</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">store</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span> <span class="nx">halObj</span><span class="p">.</span><span class="nx">addEmbed</span><span class="p">(</span><span class="s1">'stores'</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">stores</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">{</span> <span class="na">store</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">(),</span> <span class="na">copies</span><span class="p">:</span> <span class="nx">s</span><span class="p">.</span><span class="nx">copies</span> <span class="p">}</span> <span class="p">}))}}</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">authors</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">authors</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span> <span class="nx">halObj</span><span class="p">.</span><span class="nx">addEmbed</span><span class="p">(</span><span class="s1">'authors'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">authors</span><span class="p">)</span> <span class="p">}}</span>
        <span class="k">return</span> <span class="nx">halObj</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">modelDef</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/models/booksale.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">),</span>
    <span class="nx">jsonSelect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose-json-select'</span><span class="p">),</span>
    <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../lib/helpers"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../schemas/booksale.js"</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">modelDef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getModelFromSchema</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">jsonSelect</span><span class="p">,</span> <span class="s1">'-store -employee -client -books'</span><span class="p">)</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">toHAL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">halObj</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">makeHAL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span> <span class="nx">halObj</span><span class="p">.</span><span class="nx">addEmbed</span><span class="p">(</span><span class="s1">'books'</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">books</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">b</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">()</span> <span class="p">}))}}</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="nx">halObj</span><span class="p">.</span><span class="nx">addEmbed</span><span class="p">(</span><span class="s1">'store'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">store</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">())</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">employee</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="nx">halObj</span><span class="p">.</span><span class="nx">addEmbed</span><span class="p">(</span><span class="s1">'employee'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">employee</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">())</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="nx">halObj</span><span class="p">.</span><span class="nx">addEmbed</span><span class="p">(</span><span class="s1">'client'</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">())</span>
        <span class="k">return</span> <span class="nx">halObj</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">modelDef</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/models/client.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">),</span>
    <span class="nx">jsonSelect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose-json-select'</span><span class="p">),</span>
    <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../lib/helpers"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../schemas/client.js"</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">modelDef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getModelFromSchema</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">toHAL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">halObj</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">makeHAL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
        <span class="k">return</span> <span class="nx">halObj</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">modelDef</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/models/clientreview.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">),</span>
    <span class="nx">jsonSelect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose-json-select'</span><span class="p">),</span>
    <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../lib/helpers"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">)</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../schemas/clientreview.js"</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">modelDef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getModelFromSchema</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">toHAL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">halObj</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">makeHAL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
        <span class="k">return</span> <span class="nx">halObj</span>
    <span class="p">}</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'save'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">doc</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">db</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="s1">'Book'</span><span class="p">).</span><span class="nx">update</span><span class="p">({</span><span class="na">_id</span><span class="p">:</span> <span class="nx">doc</span><span class="p">.</span><span class="nx">book</span><span class="p">},</span> <span class="p">{</span><span class="na">$addToSet</span><span class="p">:</span> <span class="p">{</span><span class="na">reviews</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">}},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">})</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">modelDef</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/models/employee.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">),</span>
    <span class="nx">jsonSelect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'mongoose-json-select'</span><span class="p">),</span>
    <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../lib/helpers"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">)</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../schemas/employee.js"</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">modelDef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getModelFromSchema</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">toHAL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">halObj</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">makeHAL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">())</span>
        <span class="k">return</span> <span class="nx">halObj</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">modelDef</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">)</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/models/store.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">mongoose</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose"</span><span class="p">),</span>
    <span class="nx">jsonSelect</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"mongoose-json-select"</span><span class="p">),</span>
    <span class="nx">_</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"underscore"</span><span class="p">),</span>
    <span class="nx">helpers</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../lib/helpers"</span><span class="p">)</span>


<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">schema</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"../schemas/store.js"</span><span class="p">)</span>
    <span class="kd">var</span> <span class="nx">modelDef</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">getModelFromSchema</span><span class="p">(</span><span class="nx">schema</span><span class="p">)</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">plugin</span><span class="p">(</span><span class="nx">jsonSelect</span><span class="p">,</span> <span class="s1">'-employees'</span><span class="p">)</span>
    <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">.</span><span class="nx">methods</span><span class="p">.</span><span class="nx">toHAL</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">halObj</span> <span class="o">=</span> <span class="nx">helpers</span><span class="p">.</span><span class="nx">makeHAL</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(),</span> <span class="p">[{</span>
            <span class="na">name</span><span class="p">:</span> <span class="s1">'books'</span><span class="p">,</span>
            <span class="na">href</span><span class="p">:</span> <span class="s1">'/stores/'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">'/books'</span><span class="p">,</span>
            <span class="na">title</span><span class="p">:</span> <span class="s1">'Books'</span>
        <span class="p">},</span> <span class="p">{</span>
            <span class="na">name</span><span class="p">:</span> <span class="s1">'booksales'</span><span class="p">,</span>
            <span class="na">href</span><span class="p">:</span> <span class="s1">'/stores/'</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">'/booksales'</span><span class="p">,</span>
            <span class="na">title</span><span class="p">:</span> <span class="s1">'Book Sales'</span>
        <span class="p">}])</span>
        <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">employees</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">employees</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">toString</span><span class="p">().</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span> <span class="nx">halObj</span><span class="p">.</span><span class="nx">addEmbed</span><span class="p">(</span><span class="s1">'employees'</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">employees</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">e</span><span class="p">.</span><span class="nx">toHAL</span><span class="p">()</span> <span class="p">}))}}</span>
        <span class="k">return</span> <span class="nx">halObj</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="nx">mongoose</span><span class="p">.</span><span class="nx">model</span><span class="p">(</span><span class="nx">modelDef</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">modelDef</span><span class="p">.</span><span class="nx">schema</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">model</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="request_schemas">request_schemas</h3>

<p>This folder contains the JSON Schemas that will be used to validate the requests.</p>

<p>They need to describe an object and its properties. We should be able to validate against the request object attribute that contains the parameters (normally request.params, but potentially something else, such as request.body).</p>

<p>Due to the type of attributes we defined for our endpoints, there is really only one endpoint that we would want to validate: the getBookSales (GET /booksales) endpoint. It receives two date parameters, and we probably want to validate their format to be 100% certain that the dates are valid.</p>

<p>Again, to provide the simplicity of usage that “convention over configuration” provides, our schema files must follow a very specific format, which is then used by the validator that we saw earlier:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="o">/</span><span class="nx">request_schemas</span><span class="o">/</span> <span class="p">[</span><span class="nx">CONTROLLER</span> <span class="nx">NAME</span><span class="p">].</span><span class="nx">js</span> <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">[</span><span class="nx">ENDPOINT</span> <span class="nx">NICKNAME</span><span class="p">]:</span> <span class="p">{</span>
        <span class="na">validate</span><span class="p">:</span> <span class="p">[</span><span class="nx">TYPE</span><span class="p">],</span>
        <span class="na">schema</span><span class="p">:</span> <span class="p">[</span><span class="nx">JSON</span> <span class="nx">SCHEMA</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>There are several pieces that need to be explained in the preceding code:</p>

<ul>
  <li><strong>CONTROLLER NAME</strong>: This means that the file for the schema needs to have the same name as the controller, all lowercase. And since we already did that for our controllers’ files, this mean the schemas for each controller will have to have the same name as each controller’s file.</li>
  <li><strong>ENDPOINT NICKNAME</strong>: This should be the nickname given to the action when adding it to the controller (using the addAction method).</li>
  <li><strong>TYPE</strong>: The type of object to validate. The only value supported right now is params, which references the query and path parameters received. This could be extended to support other objects.</li>
  <li><strong>JSON SCHEMA</strong>: This is where we add the actual JSON Schema defining the request parameters.</li>
</ul>

<p>Here is the actual code defining the validation for the getBookSales action:</p>

<p><em>/request_schemas/booksales.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">getbooksales</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">validate</span><span class="p">:</span> <span class="s1">'params'</span><span class="p">,</span>
        <span class="na">schema</span><span class="p">:</span> <span class="p">{</span>
            <span class="na">type</span><span class="p">:</span> <span class="s2">"object"</span><span class="p">,</span>
            <span class="na">properties</span><span class="p">:</span> <span class="p">{</span>
                <span class="na">start_date</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span>
                    <span class="na">format</span><span class="p">:</span> <span class="s1">'date'</span>
                <span class="p">},</span>
                <span class="na">end_date</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span><span class="p">,</span>
                    <span class="na">format</span><span class="p">:</span> <span class="s1">'date'</span>
                <span class="p">},</span>
                <span class="na">store_id</span><span class="p">:</span> <span class="p">{</span>
                    <span class="na">type</span><span class="p">:</span> <span class="s1">'string'</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="schemas">Schemas</h3>

<p>This folder contains the JSON Schema definitions of our resources, which also translate into the Mongoose Schemas when initializing our models.</p>

<p>The level of detail provided in these files is very important, because it also translates into the actual Mongoose model. This means that we could define things such as ranges of values and format patterns, which would be validated by Mongoose when creating the new resources.</p>

<p>For instance, let’s take a look at ClientReview, a schema that makes use of such capability:</p>

<p><em>/schemas/clientreview.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"ClientReview"</span><span class="p">,</span>
    <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"client"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Client"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The client who submits the review"</span>
        <span class="p">},</span>
        <span class="s2">"book"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Book"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The book being reviewed"</span>
        <span class="p">},</span>
        <span class="s2">"review_text"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The actual review text"</span>
        <span class="p">},</span>
        <span class="s2">"stars"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"integer"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The number of stars, from 0 to 5"</span><span class="p">,</span>
            <span class="s2">"min"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">"max"</span><span class="p">:</span> <span class="mi">5</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The stars attribute is clearly setting the maximum and minimum values that we can send when saving a new review. If we tried to send an invalid number, then we would get an error.</p>

<p>When defining schemas that reference others, remember to correctly name the reference (the name of each schema is given by the id property). So if you correctly set up the reference, the getModelFromSchema method of the db module will also properly set up the reference in Mongoose (this works both for direct reference and for collections).</p>

<p>Here is the main file for this folder; the index.js works like the index files in the other folders:</p>

<p><em>/schemas/index.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">models</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">BookSale</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./booksale"</span><span class="p">),</span>
        <span class="na">Book</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./book"</span><span class="p">),</span>
        <span class="na">Author</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./author"</span><span class="p">),</span>
        <span class="na">Store</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./store"</span><span class="p">),</span>
        <span class="na">Employee</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./employee"</span><span class="p">),</span>
        <span class="na">Client</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./client"</span><span class="p">),</span>
        <span class="na">ClientReview</span><span class="p">:</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"./clientreview"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The rest of the schemas defined for the project:</p>

<p><em>/schemas/author.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"Author"</span><span class="p">,</span>
    <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The full name of the author"</span>
        <span class="p">},</span>
        <span class="s2">"description"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"A small bio of the author"</span>
        <span class="p">},</span>
        <span class="s2">"books"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"array"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The list of books published on at least one of the stores by this author"</span><span class="p">,</span>
            <span class="s2">"items"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Book"</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">"website"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The Website url of the author"</span>
        <span class="p">},</span>
        <span class="s2">"avatar"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The url for the avatar of this author"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/schema/book.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"Book"</span><span class="p">,</span>
    <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"title"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The title of the book"</span>
        <span class="p">},</span>
        <span class="s2">"authors"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span><span class="s2">"array"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span><span class="s2">"List of authors of the book"</span><span class="p">,</span>
            <span class="s2">"items"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Author"</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">"isbn_code"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Unique identifier code of the book"</span><span class="p">,</span>
            <span class="s2">"type"</span><span class="p">:</span><span class="s2">"string"</span>
        <span class="p">},</span>
        <span class="s2">"stores"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"array"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The stores where clients can buy this book"</span><span class="p">,</span>
            <span class="s2">"items"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"object"</span><span class="p">,</span>
                <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">"store"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Store"</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">"copies"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"integer"</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">"genre"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Genre of the book"</span>
        <span class="p">},</span>
        <span class="s2">"description"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Description of the book"</span>
        <span class="p">},</span>
        <span class="s2">"reviews"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"array"</span><span class="p">,</span>
            <span class="s2">"items"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"ClientReview"</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">"price"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"number"</span><span class="p">,</span>
            <span class="s2">"minimun"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The price of this book"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/schemas/booksales.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"BookSale"</span><span class="p">,</span>
    <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"date"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"date"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Date of the transaction"</span>
        <span class="p">},</span>
        <span class="s2">"books"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"array"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Books sold"</span><span class="p">,</span>
            <span class="s2">"items"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Book"</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">"store"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"object"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The store where this sale took place"</span><span class="p">,</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"object"</span><span class="p">,</span>
            <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Store"</span>
        <span class="p">},</span>
        <span class="s2">"employee"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"object"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The employee who makes the sale"</span><span class="p">,</span>
            <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Employee"</span>
        <span class="p">},</span>
        <span class="s2">"client"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"object"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The person who gets the books"</span><span class="p">,</span>
            <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Client"</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="s2">"totalAmount"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"integer"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/schemas/client.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"Client"</span><span class="p">,</span>
    <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Full name of the client"</span>
        <span class="p">},</span>
        <span class="s2">"address"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Address of residence of this client"</span>
        <span class="p">},</span>
        <span class="s2">"phone_number"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Contact phone number for the client"</span>
        <span class="p">},</span>
        <span class="s2">"email"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Email of the client"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>/schemas/employee.js</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"Employee"</span><span class="p">,</span>
    <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"first_name"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"First name of the employee"</span>
        <span class="p">},</span>
        <span class="s2">"last_name"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Last name of the employee"</span>
        <span class="p">},</span>
        <span class="s2">"birthdate"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Date of birth of this employee"</span>
        <span class="p">},</span>
        <span class="s2">"address"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Address for the employee"</span>
        <span class="p">},</span>
        <span class="s2">"phone_numbers"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"array"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"List of phone numbers of this employee"</span><span class="p">,</span>
            <span class="s2">"items"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">"email"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Employee's email"</span>
        <span class="p">},</span>
        <span class="s2">"hire_date"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Date when this employee was hired"</span>
        <span class="p">},</span>
        <span class="s2">"employee_number"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"number"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"Unique identifier of the employee"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p><em>/schemas/store.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">"id"</span><span class="p">:</span> <span class="s2">"Store"</span><span class="p">,</span>
    <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"name"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The actual name of the store"</span>
        <span class="p">},</span>
        <span class="s2">"address"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The address of the store"</span>
        <span class="p">},</span>
        <span class="s2">"state"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"The state where the store resides"</span>
        <span class="p">},</span>
        <span class="s2">"phone_numbers"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"array"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"List of phone numbers for the store"</span><span class="p">,</span>
            <span class="s2">"items"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"string"</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="s2">"employees"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"array"</span><span class="p">,</span>
            <span class="s2">"description"</span><span class="p">:</span> <span class="s2">"List of employees of the store"</span><span class="p">,</span>
            <span class="s2">"items"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"$ref"</span><span class="p">:</span> <span class="s2">"Employee"</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<h3 id="swagger-ui">swagger-ui</h3>

<p>This folder contains the downloaded Swagger UI project, so we will not go over this particular code; however, I will mention the minor modifications we’ll need to do to the index.html file to get the UI to properly load.</p>

<ol>
  <li>Edit the routes for all the resources loaded (CSS and JS files) to start with
swagger-ui/.</li>
  <li>Change the URL for the documentation server to http://localhost:9000/api-
docs (around line 31).</li>
  <li>Uncomment the block of code in line 73. Set the right value to the apiKey
variable (set it to 777).</li>
</ol>

<h3 id="root-folder">Root Folder</h3>

<p>This is the root of the project. There are only two files here: the main index.js and the package.json file that contains the dependencies and other project attributes.</p>

<p><em>/package.json</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="p">{</span>
    <span class="s2">"name"</span><span class="err">:</span> <span class="s2">"come_n_read"</span><span class="p">,</span>
    <span class="s2">"version"</span><span class="err">:</span> <span class="s2">"1.0.0"</span><span class="p">,</span>
    <span class="s2">"description"</span><span class="err">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="s2">"main"</span><span class="err">:</span> <span class="s2">"index.js"</span><span class="p">,</span>
    <span class="s2">"scripts"</span><span class="err">:</span> <span class="p">{</span>
        <span class="s2">"test"</span><span class="err">:</span> <span class="s2">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>
    <span class="p">},</span>
    <span class="s2">"author"</span><span class="err">:</span> <span class="s2">""</span><span class="p">,</span>
    <span class="s2">"license"</span><span class="err">:</span> <span class="s2">"ISC"</span><span class="p">,</span>
    <span class="s2">"dependencies"</span><span class="err">:</span> <span class="p">{</span>
        <span class="s2">"colors"</span><span class="err">:</span> <span class="s2">"^1.0.3"</span><span class="p">,</span>
        <span class="s2">"halson"</span><span class="err">:</span> <span class="s2">"^2.3.1"</span><span class="p">,</span>
        <span class="s2">"mongoose"</span><span class="err">:</span> <span class="s2">"^3.8.23"</span><span class="p">,</span>
        <span class="s2">"mongoose-json-select"</span><span class="err">:</span> <span class="s2">"^0.2.1"</span><span class="p">,</span>
        <span class="s2">"restify"</span><span class="err">:</span> <span class="s2">"^2.8.5"</span><span class="p">,</span>
        <span class="s2">"swagger-node-restify"</span><span class="err">:</span> <span class="s2">"^0.1.2"</span><span class="p">,</span>
        <span class="s2">"tv4"</span><span class="err">:</span> <span class="s2">"^1.1.9"</span><span class="p">,</span>
        <span class="s2">"tv4-formats"</span><span class="err">:</span> <span class="s2">"^1.0.0"</span><span class="p">,</span>
        <span class="s2">"underscore"</span><span class="err">:</span> <span class="s2">"^1.7.0"</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>The most interesting part of this file is the list of dependencies. The rest was autogenerated using the init option of the npm command-line tool.</p>

<p><em>/index.js</em></p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">restify</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"restify"</span><span class="p">),</span>
    <span class="nx">colors</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"colors"</span><span class="p">),</span>
    <span class="nx">swagger</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"swagger-node-restify"</span><span class="p">),</span>
    <span class="nx">config</span>  <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">config</span>

<span class="kd">var</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">restify</span><span class="p">.</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">server</span><span class="p">)</span>

<span class="c1">// Middleware setup</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">restify</span><span class="p">.</span><span class="nx">queryParser</span><span class="p">())</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">restify</span><span class="p">.</span><span class="nx">bodyParser</span><span class="p">())</span>

<span class="nx">restify</span><span class="p">.</span><span class="nx">defaultResponseHeaders</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">head</span><span class="p">(</span><span class="s1">'Access-Control-Allow-Origin'</span><span class="p">,</span><span class="s1">'*'</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Middleware to check for valid api key sent</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="c1">// Move forward if we're dealing with the swagger-ui or a valid key</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"swagger-ui"</span><span class="p">)</span> <span class="o">!=-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">validateKey</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">hmacdata</span> <span class="o">||</span> <span class="s1">''</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">api_key</span><span class="p">,</span> <span class="nx">lib</span><span class="p">)){</span> <span class="nx">next</span><span class="p">()</span> <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span> <span class="nx">req</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">401</span><span class="p">,</span> <span class="p">{</span><span class="na">error</span><span class="p">:</span><span class="kc">true</span><span class="p">,</span><span class="na">msg</span><span class="p">:</span><span class="s1">'Invalid api key sent'</span><span class="p">})</span> <span class="p">}</span>
<span class="p">})</span>

<span class="c1">// Vlidate each request, as long as there is a schema for it</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">use</span><span class="p">((</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">,</span><span class="nx">next</span><span class="p">)</span><span class="o">=&gt;</span><span class="p">{</span>
    <span class="kd">var</span> <span class="nx">results</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">schemaValidator</span><span class="p">.</span><span class="nx">validateRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">result</span><span class="p">.</span><span class="nx">valid</span><span class="p">)</span> <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="nx">result</span><span class="p">)</span>
    <span class="k">else</span> <span class="nx">next</span><span class="p">()</span>
<span class="p">})</span>

<span class="c1">// The swagger-ui is inside the "sagger-ui" folder</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="sr">/^</span><span class="se">\/</span><span class="sr">swagger-ui</span><span class="se">(\/</span><span class="sr">.*</span><span class="se">)?</span><span class="sr">/</span><span class="p">,</span> <span class="nx">restify</span><span class="p">.</span><span class="nx">serveStatic</span><span class="p">({</span>
    <span class="na">directory</span><span class="p">:</span> <span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">'/'</span><span class="p">,</span>
    <span class="na">default</span><span class="p">:</span> <span class="s1">'index.html'</span>
<span class="p">}))</span>

<span class="c1">// serup section</span>
<span class="nx">swagger</span><span class="p">.</span><span class="nx">addModels</span><span class="p">(</span><span class="nx">lib</span><span class="p">.</span><span class="nx">schemas</span><span class="p">)</span>
<span class="nx">swagger</span><span class="p">.</span><span class="nx">setAppHandler</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
<span class="nx">lib</span><span class="p">.</span><span class="nx">helpers</span><span class="p">.</span><span class="nx">setupRoutes</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span><span class="nx">swagger</span><span class="p">,</span><span class="nx">lib</span><span class="p">)</span>
<span class="nx">swagger</span><span class="p">.</span><span class="nx">configureSwaggerPaths</span><span class="p">(</span><span class="s2">""</span><span class="p">,</span><span class="s2">"/api-docs"</span><span class="p">,</span><span class="s2">""</span><span class="p">)</span>  <span class="c1">//we remove the {format} part of the paths, to</span>
<span class="nx">swagger</span><span class="p">.</span><span class="nx">configure</span><span class="p">(</span><span class="s1">'http://localhost:9000'</span><span class="p">,</span> <span class="s1">'0.1'</span><span class="p">)</span>

<span class="c1">// Start the server</span>
<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">config</span><span class="p">.</span><span class="nx">server</span><span class="p">.</span><span class="nx">port</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
     <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Server started succesfully..."</span><span class="p">.</span><span class="nx">green</span><span class="p">)</span>
     <span class="nx">lib</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">connect</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
         <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Error trying to connect to database: "</span><span class="p">.</span><span class="nx">red</span><span class="p">,</span><span class="nx">err</span><span class="p">.</span><span class="nx">red</span><span class="p">)</span>
         <span class="k">else</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"Database service successfully started"</span><span class="p">.</span><span class="nx">green</span><span class="p">)</span>
     <span class="p">})</span>
<span class="p">})</span>
</code></pre>
</div>

<p>And finally, the main file, the one that starts it all up, the index.js. There are four distinct sections to this file:</p>

<ul>
  <li>The initial section, which requires all needed modules and instantiates the server.</li>
  <li>The middleware setup section, which handles setting up all pieces of middleware (we’ll go over this in a bit).</li>
  <li>The setup section, which handles loading models, controllers, setting up routes, and whatnot.</li>
  <li>The server start section, which starts the web server and the database client.</li>
</ul>

<p>The initial and final sections of the file don’t really require much explanation since they’re pretty self- explanatory, so let’s go over the other two.</p>

<h4 id="middleware-setup">Middleware Setup</h4>

<p>The middleware setup is potentially the most important part of the file and of the bootstrap process required for the API to start up and function properly.</p>

<p>But thanks to the ease of use and simplicity that the middleware mechanics bring to the table, it’s very easy to write and understand. We’re setting up five different middleware here:</p>

<ul>
  <li>The query parser to turn the query parameters into an object so that we can access them easily.</li>
  <li>The body parser so that we can access the content of the POST and PUT requests as an object, with the added bonus of autoparsing JSON strings.</li>
  <li>The security check, which takes care of rehashing the request every time to make sure that we’re dealing with an authenticated client.</li>
  <li>The validate check, which validates the request against any existing JSON Schema.</li>
  <li>The static content folder, which is not exactly a middleware, but acts as one for one
specific set of routes, allowing Restify to serve static content.</li>
</ul>

<h4 id="setup-section">Setup Section</h4>
<p>This last section is also very important; those five lines actually handles instantiating all the models, linking Swagger and the Restify server, setting up all the routes (linking the code of each action to the corresponding path and method defined in the spec section), and finally, setting up the route for the Swagger back-end server.</p>

<h2 id="summary">Summary</h2>

<p>You should now have a working version of our API, capable of doing pretty much everything we set up to do in Chapter 6. You should also have a better understanding of how these modules work. Ideally, you’ll consider them for your next project. Of course, there are alternatives like the ones discussed in the article <a href="http://develdoe.com/2016/rest-api-node-modules/">REST API Node Modules</a>.</p>

